#!/bin/bash

set -ex

repo="$(gh repo set-default --view 2>/dev/null)"
if [ "$?" = "0" ]; then
  if [ "${repo}" = "" ]; then
    gh repo set-default
    repo="$(gh repo set-default --view 2>/dev/null)"
    [ "${repo}" ] || (echo "could not determine repo" ; exit 1)
  fi
else
  repo="${GITUSER}/TODO"
fi

set -e

[ "${GITUSER}" ] || (echo "no GITUSER" ; exit 1)

op="--list"
if [ $# -gt 0 ]; then
  op="$1"
  shift
fi

cmd=""
case "${op}" in
  -h|--help)
    cat <<EOF
todo -h|-l|-a|-c|-b
-h|--help:
  help
-l|--list:
  list TODOs
-a|--add|--create ...:
  create a TODO with following subject
-c|--close ...:
  close TODO of the following number
-b|--browser:
  open issues in the browser
EOF
    exit 0
    ;;
  -l|--list)
    cmd="list --limit 100"
    ;;
  -a|--add|--create)
    cmd="create -b '' -t '$*'"
    ;;
  -c|--close)
    cmd="close $1"
    ;;
  -b|--browser)
    {{ if eq .chezmoi.os "darwin" }}open{{else}}xdg-open{{end}} "https://github.com/${repo}/issues"
    exit 0
    ;;
  *)
    cmd="${op} $@"
    ;;
esac

eval gh -R "${repo}" issue ${cmd}
