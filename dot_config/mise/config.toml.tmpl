[tools]
bat = "latest"
chezmoi = "latest"
delta = "latest"
eza = "latest"
fzf = "latest"
github-cli = "latest"
jq = "latest"
jsonschema = "latest"
ripgrep = "latest"
starship = "latest"
yq = "latest"
zellij = "latest"
{{- range $key, $val := .chezmoidata.userlocal.mise.tools }}
{{$key}} = {{$val | toToml}}
{{- end }}

[tools.neovim]
version = "latest"
postinstall = """zsh -c \"(
  source <(mise activate zsh)
  setopt LOCAL_OPTIONS XTRACE
  nvim --headless '+Lazy! sync' +qa
)\"
"""

[shell_alias]

################################################
# base utilities
################################################
la = "eza -a"
ll = "eza -l"
lla = "eza -la"
ls = "eza"
lt = "eza --tree"
# TODO: Change to -otoml once support is more complete.
tq = "yq -oy"
za = "zellij a || (echo 'Starting new zellij session'; zellij)"

# Sets work state.  Used by zellij-new-tab
sws = 'printf "\033]52;c;%s\007" "$(echo zellij-tab:${USER}@${HOSTNAME}:${PWD} | base64)"'
uws = 'printf "\033]52;c;\007"'


################################################
# editor
################################################
v = "nvim"
vi = "nvim"
vim = "nvim"
view = "nvim -R"
vimdiff = "nvim -d%"


################################################
# chezmoi
################################################
cm = "chezmoi"
cmc = "cd {{.chezmoi.sourceDir}}"
cmd = "chezmoi diff"
cma = "chezmoi init --apply -v"
cmeu = "$EDITOR ${HOME}/.config/chezmoi/chezmoi.userlocal.toml"
cmem = "sudo $EDITOR /var/lib/chezmoi/chezmoi.machlocal.toml"
cmu = "chezmoi update -v"
cmi = """() {(
  setopt LOCAL_OPTIONS ERREXIT
  cd {{.chezmoi.sourceDir}}
  local ignoreFile=".chezmoiignore"
  chezmoi unmanaged >> ${ignoreFile}
  LC_COLLATE=C LC_ALL=C sort -u -o ${ignoreFile} ${ignoreFile}
  git diff ${ignoreFile}
)}"""


################################################
# Package management
################################################
{{ if eq .chezmoi.os "darwin" -}}
# brew helper for mac (brew runs as a separate user)
brew = """() {
  case "$1" in
    install|update|upgrade|uninstall)
      echo "Switching user to ${BREWUSER} for brew..."
      sudo -i -u ${BREWUSER} sh -c "brew $*"
      ;;
    *)
      /opt/homebrew/bin/brew "$@"
      ;;
  esac
}"""
{{ end }}

# cross-platform native package update alias
pu = """() {(
  setopt LOCAL_OPTIONS ERREXIT XTRACE
{{ if eq .chezmoi.os "darwin" -}}
  sudo -i -u "${BREWUSER}" sh -c "HOMEBREW_NO_AUTO_UPDATE=0 NONINTERACTIVE=1 brew upgrade"
{{- else if and (eq .chezmoi.os "linux") (hasKey .chezmoi.osRelease "id") -}}
{{-   if eq .chezmoi.osRelease.idLike "debian" -}}
  sudo -i bash -c "apt update -y && apt upgrade -y && apt autoremove -y"
{{-   else if eq .chezmoi.osRelease.idLike "arch" -}}
  sudo pacman -Suy
{{-   else -}}
{{- /* other Linux distro */ -}}
{{-   end -}}
{{- else -}}
{{- /* other OS */ -}}
{{- end }}
)}"""

mu = "mise upgrade -y && mise prune -y"

u = "cmc && git pull && ./util/bootstrap.sh && cmu && pu && mu"
