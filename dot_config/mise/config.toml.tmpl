[tools]
bat = "latest"
chezmoi = "latest"
delta = "latest"
eza = "latest"
fzf = "latest"
github-cli = "latest"
jq = "latest"
jsonschema = "latest"
ripgrep = "latest"
starship = "latest"
yq = "latest"
zellij = "latest"
{{- range $key, $val := .chezmoidata.local.mise.tools }}
{{$key}} = {{$val | toToml}}
{{- end }}

[tools.neovim]
version = "latest"
postinstall = """(
  source <(mise activate zsh)
  setopt LOCAL_OPTIONS XTRACE
  nvim --headless "+Lazy! sync" +qa
)"""

[shell_alias]

################################################
# base utilities
################################################
la = "eza -a"
ll = "eza -l"
lla = "eza -la"
ls = "eza"
lt = "eza --tree"
# TODO: Change to -otoml once support is more complete.
tq = "yq -oy"


################################################
# editor
################################################
v = "nvim"
vi = "nvim"
vim = "nvim"
view = "nvim -R"
vimdiff = "nvim -d%"


################################################
# chezmoi
################################################
cm = "chezmoi"
cmc = "cd {{.chezmoi.sourceDir}}"
cmd = "chezmoi diff"
cma = "chezmoi apply -v"
cme = "$EDITOR {{.chezmoi.configFile}}"
cmu = "chezmoi update -v"
cmi = """() {(
  setopt LOCAL_OPTIONS ERREXIT
  cd {{.chezmoi.sourceDir}}
  local ignoreFile=".chezmoiignore"
  chezmoi unmanaged >> ${ignoreFile}
  LC_COLLATE=C LC_ALL=C sort -u -o ${ignoreFile} ${ignoreFile}
  git diff ${ignoreFile}
)}"""


################################################
# Package management
################################################
{{ if eq .chezmoi.os "darwin" -}}
# brew helper for mac (brew runs as a separate user)
brew = """() {
  case "$1" in
    install|update|upgrade|uninstall)
      echo "Switching user to ${BREWUSER} for brew..."
      su -l ${BREWUSER} -c "brew $*"
      ;;
    *)
      /opt/homebrew/bin/brew "$@"
      ;;
  esac
}"""
{{ end }}

# cross-platform native package update alias
pu = """() {(
  setopt LOCAL_OPTIONS ERREXIT XTRACE
{{ if eq .chezmoi.os "darwin" -}}
  su -l ${BREWUSER} -c "HOMEBREW_NO_AUTO_UPDATE=0 NONINTERACTIVE=1 brew upgrade"
{{- else if and (eq .chezmoi.os "linux") (hasKey .chezmoi.osRelease "id") -}}
{{-   if eq .chezmoi.osRelease.idLike "debian" -}}
  sudo -i bash -c "apt update -y && apt upgrade -y && apt autoremove -y"
{{-   else if eq .chezmoi.osRelease.idLike "arch" -}}
  sudo pacman -Suy
{{-   else -}}
{{- /* other Linux distro */ -}}
{{-   end -}}
{{- else -}}
{{- /* other OS */ -}}
{{- end }}
)}"""

mu = "mise upgrade -y && mise prune -y"

u = "cmu && pu && mu "


################################################
# TODO list (via github issues)
################################################
todo = """() {(
  setopt LOCAL_OPTIONS ERREXIT
  local repo="${GITUSER}/TODO"
  local op="--list"
  if [ $# -gt 0 ]; then
    op="$1"
    shift
  fi
  local cmd=""
  case "${op}" in
    -h|--help)
      cat <<EOF
todo -h|-l|-a|-c|-b
  -h|--help:
    help
  -l|--list:
    list TODOs
  -a|--add|--create ...:
    create a TODO with following subject
  -c|--close ...:
    close TODO of the following number
  -b|--browser:
    open issues in the browser
EOF
      return
      ;;
    -l|--list)
      cmd="list --limit 100"
      ;;
    -a|--add|--create)
      cmd="create -b '' -t \\"$*\\""
      ;;
    -c|--close)
      cmd="close $1"
      ;;
    -b|--browser)
      {{ if eq .chezmoi.os "darwin" }}open{{else}}xdg-open{{end}} "https://github.com/${repo}/issues"
      return
      ;;
    *)
      cmd="${op} $*"
      ;;
  esac
  eval gh -R "${repo}" issue ${cmd}
)}"""
